# Change Proposal: Fix Retransfer Inheritance Calculation Logic

## Why

現在の再転相続分の計算ロジックは、再転相続先（遺産分割前に死亡した相続人の相続人たち）に**均等分割**で相続分を配分しているが、これは**民法第896条および民法第900条に違反**している。

民法上、再転相続が発生した場合、遺産分割前に死亡した相続人の相続分は、その相続人の法定相続人（配偶者・子・直系尊属・兄弟姉妹）に**法定相続分に従って按分**されなければならない。

### 具体例

**被相続人A**の相続で、**子B**が遺産分割前に死亡した場合:
- Bの配偶者C
- Bの子D
- Bの子E

**現在の実装（誤り）**:
```
Bの相続分 1/1 → C: 1/3, D: 1/3, E: 1/3（均等分割）
```

**民法上の正しい計算**:
```
Bの相続分 1/1
→ Bの相続人への法定相続分適用
  - C（配偶者）: 1/2
  - D（子）: 1/4（子の相続分1/2を2人で分割）
  - E（子）: 1/4

最終的な相続分:
C: 1/1 × 1/2 = 1/2
D: 1/1 × 1/4 = 1/4
E: 1/1 × 1/4 = 1/4
```

この問題により、**法的に誤った相続分計算結果**が出力され、実務では使用できない状態となっている。

## What Changes

- **BREAKING**: `InheritanceCalculator._calculate_retransfer_shares()`メソッドの計算ロジックを修正
  - 均等分割から法定相続分に基づく按分に変更
  - `ShareCalculator`を再利用して、再転相続先の法定相続分を計算
  - 配偶者・子・直系尊属・兄弟姉妹の相続順位に従った正確な計算

- `InheritanceCalculator._find_retransfer_heirs()`メソッドの改善
  - 単なる生存者リストから、相続順位別の分類に変更
  - `HeirValidator`を活用した正確な相続人判定

- テストケースの修正
  - 現在のテストは誤った期待値で通過しているため、民法に基づいた正しい期待値に修正
  - 複雑ケースのテスト追加（配偶者+複数子の再転相続など）

- ドキュメント追加
  - 再転相続計算ロジックのコメント強化
  - 民法第896条の適用方法の明記

## Impact

### 影響を受けるスペック
- `inheritance-calculation`: 相続計算のコアロジック

### 影響を受けるコード
- `src/services/inheritance_calculator.py`:
  - `_calculate_retransfer_shares()` (404-429行): 計算ロジック全面修正
  - `_find_retransfer_heirs()` (376-402行): 相続人特定ロジック改善
  - `_process_retransfer_inheritance_with_info()` (234-300行): マイナー修正

- `tests/test_services/test_retransfer_inheritance.py`:
  - `test_retransfer_basic()` (14-78行): 期待値修正
  - 新規テストケース追加

### Breaking Changes
- **既存の再転相続計算結果が変更される**
  - 現在均等分割で計算されている結果が、法定相続分に基づく按分に変更される
  - これは**バグ修正**であり、正しい動作への変更

### Migration Path
- 既存のユーザーデータ（Neo4j保存データなど）がある場合、再計算が必要
- ただし、現在のロジックが法的に誤っているため、移行は必須

### Risks
- 低: 既存のロジックが民法に違反しているため、修正は必須
- テストケースの期待値が変わるが、これは正しい動作への修正

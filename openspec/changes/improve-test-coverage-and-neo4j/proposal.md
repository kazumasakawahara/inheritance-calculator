# Change Proposal: Improve Test Coverage and Neo4j Integration

## Why

現在のテストカバレッジは**59%**であり、プロジェクト目標の**75%**に達していません。特に以下の領域で大幅な改善が必要です：

### カバレッジが低い主要コンポーネント

1. **Neo4j Repositories (18%)** - データベース統合層
   - PersonRepository, RelationshipRepositoryなどの実装が未テスト
   - グラフクエリの正確性が検証されていない

2. **CLI Commands (25%)** - ユーザーインターフェース
   - コマンド実行パスの多くが未テスト
   - エラーハンドリングが検証されていない

3. **Neo4j Service (0%)** - サービス層統合
   - Neo4jとサービス層の統合が全く検証されていない

4. **Display/UI (61%)** - 出力フォーマット
   - テーブル表示、色付け、フォーマッティングが部分的にしか検証されていない

5. **Heir Validator (64%)** - 相続人資格判定
   - 代襲相続判定の一部ロジックが未テスト

### Neo4j統合の課題

現在、Neo4j関連のテストは**モック化されているが、実際のNeo4j統合テストが存在しません**。これにより：

- Cypherクエリの正確性が実環境で検証されていない
- リポジトリパターンの実装が不完全
- グラフデータベースの制約・インデックスが未検証

### 影響

- **品質リスク**: テストされていないコードは本番環境で問題を引き起こす可能性が高い
- **保守性の低下**: テストがないため、リファクタリングが困難
- **信頼性の欠如**: 民法に基づく計算結果の正確性が完全には保証されていない

## What Changes

### 1. Neo4j統合の完成 (優先度: 高)

- **Repository層の実装とテスト**
  - PersonRepository: CRUD操作、検索クエリ
  - RelationshipRepository: リレーションシップ作成・検索
  - 統合テスト（実際のNeo4j接続）の追加

- **Neo4j Service層の実装**
  - サービスとリポジトリの統合
  - トランザクション管理
  - エラーハンドリング

- **Cypherクエリの検証**
  - 相続人検索クエリの正確性テスト
  - 代襲相続クエリの検証
  - パフォーマンステスト

### 2. テストカバレッジの向上 (目標: 59% → 75%)

- **CLI Commands (25% → 70%)**
  - 主要コマンドの実行パステスト
  - エラーケースのテスト
  - ファイル入出力のテスト

- **Display/UI (61% → 80%)**
  - テーブル表示のテスト
  - 色付け・フォーマットのテスト
  - エッジケースの検証

- **Heir Validator (64% → 85%)**
  - 代襲相続判定の完全テスト
  - 相続欠格・廃除のテスト
  - エッジケースの追加

- **Database Base (68% → 85%)**
  - トランザクション管理のテスト
  - エラーハンドリングのテスト

### 3. テスト戦略の改善

- **統合テストの追加**
  - Neo4j統合テスト（オプショナル実行）
  - エンドツーエンドテスト

- **テストユーティリティの改善**
  - フィクスチャの整理
  - テストデータの標準化
  - モックの改善

## Impact

### 影響を受けるスペック
- **testing** (新規): テスト戦略とカバレッジ要件
- **neo4j-integration** (新規): Neo4j統合の要件

### 影響を受けるコード

- `tests/test_database/`:
  - test_repositories.py (新規): Repository層の統合テスト
  - test_neo4j_integration.py (新規): エンドツーエンド統合テスト

- `tests/test_cli/`:
  - test_commands.py: 既存テストの拡充
  - test_display.py: 新規テスト追加

- `tests/test_services/`:
  - test_heir_validator.py: カバレッジ拡充
  - test_neo4j_service.py (新規): Neo4jサービステスト

- `src/database/repositories.py`:
  - バグ修正と改善

- `src/services/neo4j_service.py`:
  - 実装の完成

### Breaking Changes
なし（テストとドキュメントの追加のみ）

### Migration Path
不要（既存コードへの影響なし）

### Risks
- **低**: テストの追加であり、既存機能への影響は最小限
- **Neo4j依存**: 統合テストは実際のNeo4jインスタンスが必要（オプショナル実行）
- **CI/CD**: 継続的インテグレーションでのNeo4j起動が必要になる可能性

### Benefits
- **品質向上**: バグの早期発見
- **保守性向上**: 安全なリファクタリングが可能
- **信頼性向上**: 民法準拠の計算結果の保証
- **開発効率**: テストによる迅速なフィードバック
